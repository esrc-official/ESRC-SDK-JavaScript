<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/FacialLandmarkDetector.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/FacialLandmarkDetector.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { ESRCFacialLandmark } = require("../ESRCType.js");
const tf = require("@tensorflow/tfjs");

/**
 * FacialLandmarkDetector class.
 * 
 * @author Hyunwoo Lee &lt;lhw4846@esrc.co.kr>
 * @license Copyright (c) 2022 Emotion Science Research Center all rights reserved.
 */
class FacialLandmarkDetector {
    /**
     * @constant
     * @type {number}
     * @description Constant for width of input image. 
     * @static
     */    
    static INPUT_SIZE_WIDTH = 64;
    /**
     * @constant
     * @type {number}
     * @description Constant for height of input image.
     * @static
     */
    static INPUT_SIZE_HEIGHT = 64;
    
    /**
     * @property {onDetectedFacialLandmarkCallback} onDetectedFacialLandmarkCallback A callback for when facial landmark is detected.
     */
    ondetectedCallback;
    /**
     * @property {boolean} enableFacialLandmark Whether detect facial landmark or not.
     */
    enableFacialLandmark = false;

    /**
     * @property {Promise&lt;tf.LayersModel>} detector Network for facial landmark detection.
     */
    detector;

    /**
     * @property {string} tfjsName Name of tfjs model.
     */
    tfjsName = "esrc_mobilenet_facial_landmark_detection";

    /**
     * FacialLandmarkDetector constructor.
     * @param {callback} onDetectedFacialLandmarkCallback A callback for when facial landmark is detected.
     */
    constructor(onDetectedFacialLandmarkCallback) {
        // Set handler
        this.onDetectedFacialLandmarkCallback = onDetectedFacialLandmarkCallback ?? undefined;

        // Load model
        if (!this.loadModel()) {
            throw new Error("Fail to load model for facial landmark detection.");
        }
    }

    /**
     * Initializes facial landmark detecotr.
     * @param {boolean} enableFacialLandmark Whether detect facial landmark or not.
     * @returns {boolean} Returns true if the initialization succeeded. Otherwise, false.
     */
    initialize(enableFacialLandmark) {
        var ret = true;

        // Set property
        this.enableFacialLandmark = enableFacialLandmark;

        return ret;
    }

    /**
     * Releases facial landmark detector.
     * @returns {boolean} Returns true if the release succeeded. Otherwise, false.
     */
    release() {
        var ret = true;

        return ret;
    }

    /**
     * Feed frame on facial landmark detection task.
     * @param {ESRCFace} bbox Bounding box of detected face.
     * @param {ESRCMat} mat Mat of detected face.
     */
    feed(bbox, mat) {
        if (this.enableFacialLandmark) {
            this.detector.then((res) => this.detect(res, bbox, mat))
            // .catch((err) => console.log("Error: " + err));
        }
    }

    /**
     * Load model for facial landmark detection.
     * @returns {boolean} Returns true if the load succeeded. Otherwise, false.
     */
    loadModel() {
        this.detector = tf.loadLayersModel("assets" + "/" + this.tfjsName + "/" + "model.json");
        
        return true;
    }

    /**
     * Detects facial landmark from face image.
     * @param {Promise&lt;tf.LayersModel>} res Response of promise.
     * @param {ESRCFace} bbox Bounding box of detected face.
     * @param {ESRCMat} mat Mat of detected face.
     */
    detect(res, bbox, mat) {
        let facialLandmark = new ESRCFacialLandmark(mat.getId());
        let rows = mat.getFrame().rows;
        let cols = mat.getFrame().cols;

        // Convert BGR to gray
        let inputMat = new cv.Mat();
        cv.cvtColor(mat.getFrame(), inputMat, cv.COLOR_BGR2GRAY);
        
        // Resize
        cv.resize(inputMat, inputMat, new cv.Size(FacialLandmarkDetector.INPUT_SIZE_WIDTH, FacialLandmarkDetector.INPUT_SIZE_HEIGHT), 0, 0, cv.INTER_CUBIC);  

        // Convert mat to tensor
        const input = tf.tensor(inputMat.data, [1, FacialLandmarkDetector.INPUT_SIZE_WIDTH, FacialLandmarkDetector.INPUT_SIZE_HEIGHT, 1], 'float32')

        // Predict
        const output = res.predict(input);
        
        // Convert tensor to array
        const landmarkArray = Array.from(output.dataSync());

        // Compute landmark points from model output
        for (let i = 0; i &lt; ESRCFacialLandmark.FACIAL_LANDMARK_COUNT * 2; i++) {
            if (i % 2 === 0) {  // x
                landmarkArray[i] *= cols;  // Correction for resulution
                landmarkArray[i] += bbox.getX();  // Correction for bbox
            } else {   // y
                landmarkArray[i] *= rows;  // Correction for resulution
                landmarkArray[i] += bbox.getY();  // Correction for bbox
            }
        }

        // Set facial landmark
        facialLandmark.setPositions(landmarkArray);

        // Release
        inputMat.delete();

        // Callback
        if (this.onDetectedFacialLandmarkCallback !== undefined) {
            this.onDetectedFacialLandmarkCallback(facialLandmark);
        }
    }
}

/**
 * A callback for when facial landmark is detected.
 * @callback onDetectedFacialLandmarkCallback
 * @param {ESRCFacialLandmark} facialLandmark Facial landmark.
 */
function onDetectedFacialLandmarkCallback(facialLandmark) {
    // Implement this function.
};

module.exports = FacialLandmarkDetector;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ESRCType.html">ESRCType</a></li></ul><h3>Classes</h3><ul><li><a href="APIClient.html">APIClient</a></li><li><a href="BasicFacialExpressionRecognizer.html">BasicFacialExpressionRecognizer</a></li><li><a href="EngagementRecognizer.html">EngagementRecognizer</a></li><li><a href="ESRC.html">ESRC</a></li><li><a href="ESRCHandler.html">ESRCHandler</a></li><li><a href="ESRCLicense.html">ESRCLicense</a></li><li><a href="FaceDetector.html">FaceDetector</a></li><li><a href="FacialActionUnitAnalyzer.html">FacialActionUnitAnalyzer</a></li><li><a href="FacialLandmarkDetector.html">FacialLandmarkDetector</a></li><li><a href="FileManager.html">FileManager</a></li><li><a href="MeasureEnvAnalyzer.html">MeasureEnvAnalyzer</a></li><li><a href="module-ESRCType-ESRCAttention.html">ESRCAttention</a></li><li><a href="module-ESRCType-ESRCBasicFacialExpression.html">ESRCBasicFacialExpression</a></li><li><a href="module-ESRCType-ESRCEngagement.html">ESRCEngagement</a></li><li><a href="module-ESRCType-ESRCFace.html">ESRCFace</a></li><li><a href="module-ESRCType-ESRCFacialActionUnit.html">ESRCFacialActionUnit</a></li><li><a href="module-ESRCType-ESRCFacialLandmark.html">ESRCFacialLandmark</a></li><li><a href="module-ESRCType-ESRCHeadPose.html">ESRCHeadPose</a></li><li><a href="module-ESRCType-ESRCHRV.html">ESRCHRV</a></li><li><a href="module-ESRCType-ESRCMat.html">ESRCMat</a></li><li><a href="module-ESRCType-ESRCMeasureEnv.html">ESRCMeasureEnv</a></li><li><a href="module-ESRCType-ESRCPoint2f.html">ESRCPoint2f</a></li><li><a href="module-ESRCType-ESRCProgressRatio.html">ESRCProgressRatio</a></li><li><a href="module-ESRCType-ESRCProperty.html">ESRCProperty</a></li><li><a href="module-ESRCType-ESRCRemoteHR.html">ESRCRemoteHR</a></li><li><a href="module-ESRCType-ESRCValenceFacialExpression.html">ESRCValenceFacialExpression</a></li><li><a href="OpenCVLoader.html">OpenCVLoader</a></li><li><a href="RemoteHREstimator.html">RemoteHREstimator</a></li><li><a href="ValenceFacialExpressionRecognizer.html">ValenceFacialExpressionRecognizer</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Mon Jun 27 2022 16:21:06 GMT+0900 (대한민국 표준시)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
