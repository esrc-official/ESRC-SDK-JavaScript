<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/FaceDetector.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/FaceDetector.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { ESRCMat, ESRCFace } = require("../ESRCType.js");
const FileManager = require("../utils/FileManager");

/**
 * FaceDetector class.
 * 
 * @author Hyunwoo Lee &lt;lhw4846@esrc.co.kr>
 * @license Copyright (c) 2022 Emotion Science Research Center all rights reserved.
 */
class FaceDetector {
    /**
     * @constant
     * @type {number}
     * @description Constant for threshold of confidence level.
     * @static
     */
    static CONF_THRESHOLD = 0.5;

    /**
     * @property {onDetectedFaceCallback} onDetectedFaceCallback A callback for when face is detected.
     */
    onDetectedFaceCallback;
    /**
     * @property {boolean} enableFace Whether detect face or not.
     */
    enableFace = false;

    /**
     * @property {cv.Net} detector Network for face detection.
     */
    detector;

    /**
     * @property {string} caffeName Name of caffe model.
     */
    caffeName = "esrc_ssd_mobilenet_face_detection.caffemodel";
    /**
     * @property {string} protoName Name of proto model.
     */
    protoName = "esrc_ssd_mobilenet_face_detection.prototxt";

    /**
     * FaceDetector constructor.
     * @param {onDetectedFaceCallback} onDetectedFaceCallback A callback for when face is detected.
     */
    constructor(onDetectedFaceCallback) {
        // Set handler
        this.onDetectedFaceCallback = onDetectedFaceCallback ?? undefined;

        // Load model
        if (!this.loadModel()) {
            throw new Error("Fail to load model for face detection.");
        }
    }

    /**
     * Initializes face detecotr.
     * @param {boolean} enableFace Whether detect face or not.
     * @returns {boolean} Returns true if the initialization succeeded. Otherwise, false.
     */
    initialize(enableFace) {
        var ret = true;

        // Set property
        this.enableFace = enableFace;

        return ret;
    }

    /**
     * Releases face detector.
     * @returns {boolean} Returns true if the release succeeded. Otherwise, false.
     */
    release() {
        var ret = true;

        return ret;
    }

    /**
     * Feed frame on face detection task.
     * @param {ESRCMat} mat ESRCMat instance.
     */
    feed(mat) {
        if (this.enableFace) {
            let frame = mat.getFrame();
            let sbox = new ESRCFace(mat.getId());
            let bboxMat = new ESRCMat(undefined, mat.getId());
            let sboxMat = new ESRCMat(undefined, mat.getId());

            // Detect face
            let bbox = this.detect(mat);

            // If face is detected
            if (bbox.getIsDetect()) {  
                // Make square box
                sbox = this.makeSquareBox(bbox, frame.rows, frame.cols);

                // Crop bbox from image    
                let bboxRect = new cv.Rect(bbox.getX(), bbox.getY(), bbox.getW(), bbox.getH());
                let bboxFrame = frame.roi(bboxRect);
                bboxMat.setFrame(bboxFrame);

                // Crop sbox from image
                let sboxRect = new cv.Rect(sbox.getX(), sbox.getY(), sbox.getW(), sbox.getH());
                let sboxFrame = frame.roi(sboxRect);
                sboxMat.setFrame(sboxFrame);
            } 

            // Callback
            if (this.onDetectedFaceCallback !== undefined) {
                this.onDetectedFaceCallback(bbox, bboxMat, sbox, sboxMat);
            }
        }
    }

    /**
     * Load model for face detection.
     * @returns {boolean} Returns true if the load succeeded. Otherwise, false.
     */
    loadModel() {
        FileManager.createOpenCVFileFromUrl(this.protoName, "assets" + "/" + this.protoName, () => {
            FileManager.createOpenCVFileFromUrl(this.caffeName, "assets" + "/" + this.caffeName, () => {
                this.detector = cv.readNet(this.protoName, this.caffeName);
            });
        });
        return true;
    }

    /**
     * Detects face from frame image.
     * @param {ESRCMat} mat Frame image.
     * @returns {ESRCFace} Detected face.
     */
    detect(mat) {
        let rows = mat.getFrame().rows;
        let cols = mat.getFrame().cols;
        let bbox = new ESRCFace(mat.getId());

        // Exception
        if (rows == 0 || cols == 0 || this.detector == undefined) {
            return bbox;
        }

        // Blob image
        let blob = cv.blobFromImage(mat.getFrame(), 1, {width: 100, height: 100}, [104, 117, 123, 0], false, false);

        // Detect face
        this.detector.setInput(blob);
        let detections = this.detector.forward();

        // Find face with max area
        var maxArea = 0;
        for (let i = 0, n = detections.data32F.length; i &lt; n; i += 7) {
            var conf = detections.data32F[i + 2];

            if (FaceDetector.CONF_THRESHOLD &lt;= conf &amp;&amp; conf &lt;= 1.0) {
                var x1 = detections.data32F[i + 3] * cols;
                var y1 = detections.data32F[i + 4] * rows;
                var x2 = detections.data32F[i + 5] * cols;
                var y2 = detections.data32F[i + 6] * rows;

                // Check box in image
                if (x1 >= 0 &amp;&amp; y1 >= 0 &amp;&amp; x2 &lt;= cols &amp;&amp; y2 &lt;= rows) {
                    var area = (x2 - x1) * (y2 - y1);
                    if (maxArea &lt; area) {
                        maxArea = area;
                        bbox.setIsDetect(true);
                        bbox.setX(x1);
                        bbox.setY(y1);
                        bbox.setW(x2 - x1);
                        bbox.setH(y2 - y1);
                        bbox.setConf(conf);
                    }
                }
            } 
        }

        // Release
        blob.delete();
        detections.delete();

        return bbox;
    }

    /**
     * Make square box from bounding box.
     * @param {ESRCMat} bbox Bounding box.
     * @param {number} rows Rows of image.
     * @param {number} cols Cols of image.
     * @returns {ESRCMat} Square box.
     */
    makeSquareBox(bbox, rows, cols) {
        let sbox = new ESRCFace(bbox.getId());

        // Calculate width and height with offset correction
        var left = bbox.getX();
        var right = bbox.getX() + bbox.getW();
        var top = bbox.getY();
        var bottom = bbox.getY() + bbox.getH();
        let width = bbox.getW();
        let height = bbox.getH();

        // Make square
        let diff = height - width;
        let delta = Math.abs(diff) / 2;
        if (diff > 0) {  // if height > width
            left -= delta;
            right += delta;

            if (diff % 2.0 == 1) {
                right += 1;
            }
        } else if (diff &lt; 0) {  // if height &lt; width
            top -= delta;
            bottom += delta;

            if (diff % 2.0 == 1) {
                bottom += 1;
            }
        }

        // If sbox in image
        if (left >= 0 &amp;&amp; top >= 0 &amp;&amp; right &lt;= cols &amp;&amp; bottom &lt;= rows) {
            // Make square box
            sbox.setIsDetect(true);
            sbox.setX(left);
            sbox.setY(top);
            sbox.setW(right - left);
            sbox.setH(bottom - top);
            sbox.setConf(bbox.getConf());
        }
        
        return sbox;
    }
}

/**
 * A callback for when face is detected.
 * @callback onDetectedFaceCallback
 * @param {ESRCFace} bbox Bounding box of detected face.
 * @param {ESRCMat} bboxMat Mat instance for bounding box of detected face.
 * @param {ESRCFace} sbox Square box of detected face.
 * @param {ESRCMat} sboxMat Mat instance for square box of detected face.
 */
function onDetectedFaceCallback(bbox, bboxMat, sbox, sboxMat) {
    // Implement this function.
};

module.exports = FaceDetector;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ESRCType.html">ESRCType</a></li></ul><h3>Classes</h3><ul><li><a href="APIClient.html">APIClient</a></li><li><a href="BasicFacialExpressionRecognizer.html">BasicFacialExpressionRecognizer</a></li><li><a href="EngagementRecognizer.html">EngagementRecognizer</a></li><li><a href="ESRC.html">ESRC</a></li><li><a href="ESRCHandler.html">ESRCHandler</a></li><li><a href="ESRCLicense.html">ESRCLicense</a></li><li><a href="FaceDetector.html">FaceDetector</a></li><li><a href="FacialActionUnitAnalyzer.html">FacialActionUnitAnalyzer</a></li><li><a href="FacialLandmarkDetector.html">FacialLandmarkDetector</a></li><li><a href="FileManager.html">FileManager</a></li><li><a href="MeasureEnvAnalyzer.html">MeasureEnvAnalyzer</a></li><li><a href="module-ESRCType-ESRCAttention.html">ESRCAttention</a></li><li><a href="module-ESRCType-ESRCBasicFacialExpression.html">ESRCBasicFacialExpression</a></li><li><a href="module-ESRCType-ESRCEngagement.html">ESRCEngagement</a></li><li><a href="module-ESRCType-ESRCFace.html">ESRCFace</a></li><li><a href="module-ESRCType-ESRCFacialActionUnit.html">ESRCFacialActionUnit</a></li><li><a href="module-ESRCType-ESRCFacialLandmark.html">ESRCFacialLandmark</a></li><li><a href="module-ESRCType-ESRCHeadPose.html">ESRCHeadPose</a></li><li><a href="module-ESRCType-ESRCHRV.html">ESRCHRV</a></li><li><a href="module-ESRCType-ESRCMat.html">ESRCMat</a></li><li><a href="module-ESRCType-ESRCMeasureEnv.html">ESRCMeasureEnv</a></li><li><a href="module-ESRCType-ESRCPoint2f.html">ESRCPoint2f</a></li><li><a href="module-ESRCType-ESRCProgressRatio.html">ESRCProgressRatio</a></li><li><a href="module-ESRCType-ESRCProperty.html">ESRCProperty</a></li><li><a href="module-ESRCType-ESRCRemoteHR.html">ESRCRemoteHR</a></li><li><a href="module-ESRCType-ESRCValenceFacialExpression.html">ESRCValenceFacialExpression</a></li><li><a href="OpenCVLoader.html">OpenCVLoader</a></li><li><a href="RemoteHREstimator.html">RemoteHREstimator</a></li><li><a href="ValenceFacialExpressionRecognizer.html">ValenceFacialExpressionRecognizer</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Mon Jun 27 2022 16:21:06 GMT+0900 (대한민국 표준시)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
