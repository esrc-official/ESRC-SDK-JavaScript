<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/BasicFacialExpressionRecognizer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/BasicFacialExpressionRecognizer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { ESRCBasicFacialExpression, ESRCMat } = require("../ESRCType.js");
const tf = require("@tensorflow/tfjs");

/**
 * BasicFacialExpressionRecognizer class.
 * 
 * @author Hyunwoo Lee &lt;lhw4846@esrc.co.kr>
 * @license Copyright (c) 2022 Emotion Science Research Center all rights reserved.
 */
class BasicFacialExpressionRecognizer {
    /**
     * @constant
     * @type {number}
     * @description Constant for width of input image.
     * @static
     */
    static INPUT_SIZE_WIDTH = 64;
    /**
     * @constant
     * @type {number}
     * @description Constant for height of input image.
     * @static
     */
    static INPUT_SIZE_HEIGHT = 64;

    /**
     * @property {onRecognizedBasicFacialExpressionCallback} onRecognizedBasicFacialExpressionCallback A callback for when basic facial expression is recognized.
     */
    onRecognizedBasicFacialExpressionCallback;
    /**
     * @property {boolean} enableBasicFacialExpression Whether recognize basic facial expression or not.
     */
    enableBasicFacialExpression = false;

    /**
     * @property {Promise&lt;tf.LayersModel>} recognizer Network for basic facial expression recognition.
     */
    recognizer;

    /**
     * @property {string} tfjsName Name of tfjs model.
     */
    tfjsName = "esrc_mobilenet_basic_facial_expression_recognition";

    /**
     * BasicFacialExpressionRecognizer constructor.
     * @param {onRecognizedBasicFacialExpressionCallback} onRecognizedBasicFacialExpressionCallback A callback for when basic facial expression is recognized.
     */
    constructor(onRecognizedBasicFacialExpressionCallback) {
        // Set handler
        this.onRecognizedBasicFacialExpressionCallback = onRecognizedBasicFacialExpressionCallback ?? undefined;

        // Load model
        if (!this.loadModel()) {
            throw new Error("Fail to load model for basic facial expression recognition.");
        }
    }

    /**
     * Initializes basic facial expression recognizer.
     * @param {boolean} enableBasicFacialExpression Whether recognize basic facial expression or not.
     * @returns {boolean} Returns true if the initialization succeeded. Otherwise, false.
     */
    initialize(enableBasicFacialExpression) {
        var ret = true;

        // Set property
        this.enableBasicFacialExpression = enableBasicFacialExpression;

        return ret;
    }

    /**
     * Releases basic facial expression recognizer.
     * @returns {boolean} Returns true if the release succeeded. Otherwise, false.
     */
    release() {
        var ret = true;

        return ret;
    }

    /**
     * Feed frame on basic facial expression recognition task.
     * @param {ESRCMat} mat Mat of detected face.
     */
    feed(mat) {
        if (this.enableBasicFacialExpression) {            
            this.recognizer.then((res) => this.recognize(res, mat))
            // .catch((err) => console.log("Error: " + err));
        }
    }

    /**
     * Load model for basic facial expression recognition.
     * @returns {boolean} Returns true if the load succeeded. Otherwise, false.
     */
    loadModel() {
        this.recognizer = tf.loadLayersModel("assets" + "/" + this.tfjsName + "/" + "model.json");
        
        return true;
    }

    /**
     * Recognizes basic facial expression from face image.
     * @param {Promise&lt;tf.LayersModel>} res Response of promise
     * @param {ESRCMat} mat Mat of detected face.
     */
    recognize(res, mat) {
        let basicFacialExpression = new ESRCBasicFacialExpression(mat.getId());

        // Convert BGR to gray
        let inputMat = new cv.Mat();
        cv.cvtColor(mat.getFrame(), inputMat, cv.COLOR_BGR2GRAY);
        
        // Resize
        cv.resize(inputMat, inputMat, new cv.Size(BasicFacialExpressionRecognizer.INPUT_SIZE_WIDTH, BasicFacialExpressionRecognizer.INPUT_SIZE_HEIGHT), 0, 0, cv.INTER_CUBIC);  

        // Convert mat to tensor
        const input = tf.tensor(inputMat.data, [1, BasicFacialExpressionRecognizer.INPUT_SIZE_WIDTH, BasicFacialExpressionRecognizer.INPUT_SIZE_HEIGHT, 1], 'float32')

        // Predict 
        const output = res.predict(input);

        // Convert tensor to array
        const emotionProbsArray = Array.from(output.dataSync());

        // Get emotion
        const emotion = this.getDominantProbIndex(emotionProbsArray);

        // Set basic facial expression
        basicFacialExpression.setEmotionProbs(emotionProbsArray);
        basicFacialExpression.setEmotion(emotion);

        // Release
        inputMat.delete();

        // Callback
        if (this.onRecognizedBasicFacialExpressionCallback !== undefined) {
            this.onRecognizedBasicFacialExpressionCallback(basicFacialExpression);            
        }
    }

    /**
     * Returns index of dominant probability.
     * @param {Array.&lt;number>} weights Probabilities
     * @returns {number} Index of diminant probability.
     */
    getDominantProbIndex(weights) {
        var dominantProbIndex = -1;
        var maxWeight = 0;
        var maxIndex = 0;

        for (let i = 0; i &lt; weights.length; i++) {
            if (weights[i] > maxWeight) {
                maxWeight = weights[i];
                maxIndex = i;
            }
        }

        dominantProbIndex = maxIndex;

        return dominantProbIndex;
    }
}

/**
 * A callback for when basic facial expression is recognized.
 * @callback onRecognizedBasicFacialExpressionCallback
 * @param {ESRCBasicFacialExpression} facialExpression Basic facial expression.
 */
function onRecognizedBasicFacialExpressionCallback(facialExpression) {
    // Implement this function.
};

module.exports = BasicFacialExpressionRecognizer;</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ESRCType.html">ESRCType</a></li></ul><h3>Classes</h3><ul><li><a href="APIClient.html">APIClient</a></li><li><a href="BasicFacialExpressionRecognizer.html">BasicFacialExpressionRecognizer</a></li><li><a href="EngagementRecognizer.html">EngagementRecognizer</a></li><li><a href="ESRC.html">ESRC</a></li><li><a href="ESRCHandler.html">ESRCHandler</a></li><li><a href="ESRCLicense.html">ESRCLicense</a></li><li><a href="FaceDetector.html">FaceDetector</a></li><li><a href="FacialActionUnitAnalyzer.html">FacialActionUnitAnalyzer</a></li><li><a href="FacialLandmarkDetector.html">FacialLandmarkDetector</a></li><li><a href="FileManager.html">FileManager</a></li><li><a href="MeasureEnvAnalyzer.html">MeasureEnvAnalyzer</a></li><li><a href="module-ESRCType-ESRCAttention.html">ESRCAttention</a></li><li><a href="module-ESRCType-ESRCBasicFacialExpression.html">ESRCBasicFacialExpression</a></li><li><a href="module-ESRCType-ESRCEngagement.html">ESRCEngagement</a></li><li><a href="module-ESRCType-ESRCFace.html">ESRCFace</a></li><li><a href="module-ESRCType-ESRCFacialActionUnit.html">ESRCFacialActionUnit</a></li><li><a href="module-ESRCType-ESRCFacialLandmark.html">ESRCFacialLandmark</a></li><li><a href="module-ESRCType-ESRCHeadPose.html">ESRCHeadPose</a></li><li><a href="module-ESRCType-ESRCHRV.html">ESRCHRV</a></li><li><a href="module-ESRCType-ESRCMat.html">ESRCMat</a></li><li><a href="module-ESRCType-ESRCMeasureEnv.html">ESRCMeasureEnv</a></li><li><a href="module-ESRCType-ESRCPoint2f.html">ESRCPoint2f</a></li><li><a href="module-ESRCType-ESRCProgressRatio.html">ESRCProgressRatio</a></li><li><a href="module-ESRCType-ESRCProperty.html">ESRCProperty</a></li><li><a href="module-ESRCType-ESRCRemoteHR.html">ESRCRemoteHR</a></li><li><a href="module-ESRCType-ESRCValenceFacialExpression.html">ESRCValenceFacialExpression</a></li><li><a href="OpenCVLoader.html">OpenCVLoader</a></li><li><a href="RemoteHREstimator.html">RemoteHREstimator</a></li><li><a href="ValenceFacialExpressionRecognizer.html">ValenceFacialExpressionRecognizer</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Mon Jun 27 2022 16:21:06 GMT+0900 (대한민국 표준시)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
